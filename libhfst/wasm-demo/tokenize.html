<html>

<head>
  <meta charset="utf-8">
  <title>HFST WASM Lookup Demo</title>
</head>

<body>
  <h1>HFST Word Analysis</h1>

  <div>
    <h2>1. Upload an HFST transducer file</h2>
    <input type="file" id="transducerFile">
    <div id="uploadStatus">Please upload a transducer file</div>
  </div>

  <div>
    <h2>2. Tokenize words</h2>
    <textarea id="textInput" placeholder="Enter text to analyze" rows="10" cols="80"></textarea>
    <br>
    <select id="outputFormatSelect">
      <option value="0">tokenize</option>
      <option value="1">space_separated</option>
      <option value="2">xerox</option>
      <option value="3">cg</option>
      <option value="4">finnpos</option>
      <option value="5" selected>giellacg</option>
      <option value="6">conllu</option>
      <option value="7">visl</option>
    </select>
    <button id="tokenizeButton" disabled>Tokenize</button>
    <div id="results"></div>
    <div id="structuredResults"></div>
  </div>

  <!-- Load the libhfst.js file -->
  <script src="../libhfst.js"></script>
  <script>
    let hfst;
    let currentTransducer = null;
    let tokenizeSettings;

    // Initialize HFST module
    async function initHfst() {
      console.log('Loading HFST module...');
      await createHfstModule().then((hfstModule) => {
        hfst = hfstModule;
        console.log('    ...HFST module loaded as `hfst`');

        // Initialize tokenize settings once
        tokenizeSettings = hfst.getDefaultTokenizeSettings();

        // Enable file upload once HFST is ready
        document.getElementById('transducerFile').addEventListener('change', handleFileUpload);
      });
    }

    // Handle transducer file upload
    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const uploadStatus = document.getElementById('uploadStatus');
      uploadStatus.textContent = `Loading ${file.name}...`;

      try {
        // Read the file
        const arrayBuffer = await file.arrayBuffer();
        const uint8Array = new Uint8Array(arrayBuffer);

        // Write to Emscripten's filesystem
        const filename = `/${file.name}`;
        hfst.FS.writeFile(filename, uint8Array);

        // Load the transducer
        currentTransducer = hfst.createPmatchContainer(filename);

        uploadStatus.textContent = `Transducer "${file.name}" loaded successfully!`;
        document.getElementById('tokenizeButton').disabled = false;
      } catch (error) {
        console.error('Error loading transducer:', error);
        uploadStatus.textContent = `Error: ${error.message}`;
        document.getElementById('tokenizeButton').disabled = true;
      }
    }

    // Initialize the application
    initHfst();

    document.getElementById('tokenizeButton').addEventListener('click', tokenize);

    function tokenize() {
      let text = document.getElementById('textInput').value.trim();
      const outputFormat = parseInt(document.getElementById('outputFormatSelect').value);
      console.log('Output format:', outputFormat);
      tokenizeSettings.output_format = outputFormat;
      console.log('Tokenize settings:', tokenizeSettings);
      const resultsDiv = document.getElementById('results');
      const structuredResultsDiv = document.getElementById('structuredResults');

      if (!text) {
        // TODO remove autofill
        // resultsDiv.textContent = 'Please upload a transducer file first';
        text = 'Мы уже работаем над этим. What do you mean?';
        document.getElementById('textInput').value = text;
      }

      if (!currentTransducer) {
        resultsDiv.textContent = 'Please upload a transducer file first';
        return;
      }

      try {
        const results = currentTransducer.tokenize(text, tokenizeSettings);
        console.log(`String results (${text}):`, results);

        // Clear previous results and add new structure
        resultsDiv.innerHTML = '<p>Tokenization results:</p>'; // Keep the paragraph
        const preElement = document.createElement('pre');
        preElement.textContent = results; // Use textContent for automatic escaping
        resultsDiv.appendChild(preElement);

        const structuredResults = currentTransducer.tokenizeStructured(text, tokenizeSettings);
        console.log(`Structured results (${text}):`, structuredResults);

        // Clear previous results and add new structure for structured results
        structuredResultsDiv.innerHTML = '<p>Tokenization results (structured):</p>'; // Keep the paragraph
        const structuredPreElement = document.createElement('pre');
        structuredPreElement.textContent = JSON.stringify(structuredResults, null, 2); // Use textContent
        structuredResultsDiv.appendChild(structuredPreElement);

      } catch (error) {
        console.error('Error in lookup:', error);
        // Use textContent here too for safety
        resultsDiv.textContent = 'Error analyzing word: ' + error.message;
        structuredResultsDiv.textContent = ''; // Clear structured results on error
      }
    }
  </script>
</body>

</html>
